{% extends "base.html" %}
{% block content %}


<div>
  {{ macros.m_row_start() }}  
  {{ macros.m_button('group_add_btn', '그룹 추가') }}
  {{ macros.m_row_end() }}  
  {{ macros.m_hr_head_top() }}
  {{ macros.m_row_start('0') }}
  {{ macros.m_col(1, macros.m_strong('ID')) }}
  {{ macros.m_col(2, macros.m_strong('Group Name')) }}
  {{ macros.m_col(4, macros.m_strong('Board')) }}
  {{ macros.m_col(5, macros.m_strong('Last Feed')) }}
  {{ macros.m_row_end() }}
  {{ macros.m_hr_head_bottom() }}
  <div id="group_list_div"></div>
</div> <!--전체-->


<!-- Modal -->

<div class="modal fade" id="add_group_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modal_title">그룹 추가</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body" id="modal_body" style="word-break:break-all;">
        {{ macros.setting_input_text('add_group_text', '그룹명', col='6') }}
      </div>
      <div class="modal-footer">
        <button id="add_group_save_btn" type="button" class="btn btn-primary">저장</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="add_group_child_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="modal_title">목록 추가</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="modal-body" id="modal_body" style="word-break:break-all;">
        {{ macros.setting_top('사이트') }}
        <div id="site_list_on_group_option" class="input-group col-sm-6">
        </div>
        {{ macros.setting_bottom() }}
        {{ macros.setting_top('게시판') }}
        <div id="board_select_on_group_div" class="input-group col-sm-6">
        </div>
        {{ macros.setting_bottom() }}
      </div>
      <div class="modal-footer">
        <button id="add_group_child_save_btn" type="button" class="btn btn-primary">저장</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>




<script type="text/javascript">
var package_name = "{{arg['package_name'] }}";

var current_data;
var current_group_id;


$(document).ready(function(){
  // 로딩
  $.ajax({
    url: '/'+package_name+'/ajax/load_group',
    type: "POST", 
    cache: false,
    data:{},
    dataType: "json",
    success: function (data) {
      current_data = data;
      make_group_list(data.group);
    }
  });
});


  



$("#group_add_btn").click(function(e) {
  e.preventDefault();
  $("#add_group_modal").modal();
});

$("#add_group_save_btn").click(function(e) {
  e.preventDefault();
  groupname = document.getElementById("add_group_text").value;
  $.ajax({
    url: '/' + package_name + '/ajax/add_group',
    type: "POST", 
    cache: false,
    data:{groupname:groupname},
    dataType: "json",
    success: function (data) {
      current_data = data;
      if (data.ret == 'success') {
        $.notify('<strong>저장하였습니다.</strong>', {
          type: 'success'
        });
        $("#add_group_modal").modal('hide');
      } else if (data.ret == 'already_exist') {
        $.notify('<strong>이미 존재합니다.</strong>', {
          type: 'warning'
        });
      } else if (data.ret == 'fail') {
        $.notify('<strong>실패하였습니다.</strong>', {
          type: 'warning'
        });
        $("#add_group_modal").modal('hide');
      }
      make_group_list(data.group);
    }
  });
});

// 그룹 자식 추가 버튼
$("body").on('click', '#add_group_child_btn', function(e){
  e.preventDefault();
  console.log(current_data)
  var data = current_data.site;
  current_group_id = $(this).data('id');
  str = '<select id="site_select_on_group" name="site_select_on_group" class="form-control form-control-sm" value="'+ data[0].info.NAME+'">';
  for (var i in data) {
    str += '<option value="'+ data[i].info.NAME +'">'+data[i].info.NAME+'</option>';
  }
  document.getElementById("site_list_on_group_option").innerHTML = str;
  $('#site_select_on_group').trigger('change');
  $("#add_group_child_modal").modal();
});


$("body").on('change', '#site_select_on_group', function(e){
  e.preventDefault();
  site = document.getElementById("site_select_on_group").value;
  $("#board_select_on_group").empty();
  str = '<select id="board_select_on_group" name="board_select_on_group" class="form-control form-control-sm">';
  for(var i in current_data.info.board[site]) {
    str += '<option value="' + current_data.info.board[site][i] + '">' + current_data.info.board[site][i] + '</option>';
  }
  str += '</select>';
  document.getElementById("board_select_on_group_div").innerHTML = str;
});

$("#add_group_child_save_btn").click(function(e) {
  e.preventDefault();
  sitename = document.getElementById("site_select_on_group").value;
  boardname = document.getElementById("board_select_on_group").value;
  $.ajax({
    url: '/' + package_name + '/ajax/add_group_child',
    type: "POST", 
    cache: false,
    data:{group_id:current_group_id, sitename:sitename, boardname:boardname},
    dataType: "json",
    success: function (data) {
      current_data = data;
      $("#add_group_child_modal").modal('hide');
      if (data.ret == 'success') {
        $.notify('<strong>저장하였습니다.</strong>', {
          type: 'success'
        });
      } else if (data.ret == 'already_exist') {
        $.notify('<strong>이미 존재합니다.</strong>', {
          type: 'warning'
        });
      } else if (data.ret == 'fail') {
        $.notify('<strong>실패하였습니다.</strong>', {
          type: 'warning'
        });
      }
      make_group_list(data.group);
    }
  });
});

// 그룹 삭제 버튼
$("body").on('click', '#remove_group_btn', function(e){
  e.preventDefault();
  group_id = $(this).data('id');
  $.ajax({
    url: '/' + package_name + '/ajax/remove_group',
    type: "POST", 
    cache: false,
    data:{group_id:group_id},
    dataType: "json",
    success: function (data) {
      current_data = data;
      if (data.ret == 'success') {
        $.notify('<strong>삭제하였습니다.</strong>', {
          type: 'success'
        });
      } else if (data.ret == 'not_exist') {
        $.notify('<strong>존재하지 않습니다.</strong>', {
          type: 'warning'
        });
      } else if (data.ret == 'fail') {
        $.notify('<strong>실패하였습니다.</strong>', {
          type: 'warning'
        });
      }
      make_group_list(data.group);
    }
  });
});

// 그룹 자식 삭제 버튼
$("body").on('click', '#remove_group_child_btn', function(e){
  e.preventDefault();
  group_id = $(this).data('id');
  child_id = $(this).data('child_id');
  $.ajax({
    url: '/' + package_name + '/ajax/remove_group_child',
    type: "POST", 
    cache: false,
    data:{group_id:group_id, child_id:child_id},
    dataType: "json",
    success: function (data) {
      current_data = data;
      if (data.ret == 'success') {
        $.notify('<strong>삭제하였습니다.</strong>', {
          type: 'success'
        });
      } else if (data.ret == 'not_exist') {
        $.notify('<strong>존재하지 않습니다.</strong>', {
          type: 'warning'
        });
      } else if (data.ret == 'fail') {
        $.notify('<strong>실패하였습니다.</strong>', {
          type: 'warning'
        });
      }
      make_group_list(data.group);
    }
  });
});
  


function make_group_list(data) {
  str = ''
  
  for(var i in data) {
    str += ' \
      <div class="row"> \
        <div class="col-sm-1" style="text-align: center;" style="padding-top:0px; padding-bottom:0px">'
    str += data[i].id;
    str += '\
        </div> \
        <div class="col-sm-2" style="padding-top:0px; padding-bottom:0px"> \
          <strong>' + data[i].groupname + '</strong><p></p>'
    str += ' \
          <div class="btn-group btn-group-sm" role="group" > \
            <button id="remove_group_btn" class="btn btn-sm btn-outline-success" data-id="' + data[i].id + '">그룹 삭제</button> \
            <button id="add_group_child_btn" class="btn btn-sm btn-outline-success" data-id="' + data[i].id + '">목록 추가</button> \
          </div> \
        </div>'
    
    str += ' \
        <div class="col-sm-4" style="text-align: left;" style="padding-top:0px; padding-bottom:0px">';
    for (var j in data[i].schedulers) {
      str += '<div class="row col-sm-12">'
      str += '<div class="col-sm-5" style="text-align:left;" style="padding-top:0px; padding-bottom:0px">' + data[i].schedulers[j].sitename + '</div>'
      str += '<div class="col-sm-5" style="text-align: left;" style="padding-top:0px; padding-bottom:0px">' + data[i].schedulers[j].board_id + '</div>'
      str += '<div class="col-sm-2" style="text-align: left;" style="padding-top:0px; padding-bottom:0px"><button id="remove_group_child_btn" class="btn btn-sm btn-outline-success" data-id="' + data[i].id + '" data-child_id="'+data[i].schedulers[j].id+'">삭제</button></div>'
      str += '</div>';
      if (j != data[i].schedulers.length -1)
        str += '<hr style="width: 100%; margin-bottom:1px; margin-top:1px;" />'
    }
    str += '</div>';

    str += ' \
        <div class="col-sm-5 form-inline" style="padding-top:0px; padding-bottom:0px"> \
          <input id="query" name="query" class="form-control form-control-sm w-100" type="text" placeholder="쿼리" aria-label="Search"> \
          <button id="sava_group_child_query_btn" class="btn btn-sm btn-outline-success" data-id="' + data[i].id + '">저장</button> \
        </div> \
      </div>'
    
    str += '<div class="row"><div class="col-sm-1"></div> \
    <div class="col-sm-11" style="text-align: left;" style="padding-top:0px; padding-bottom:0px"><a href="'+data[i].rss+'" target="_blank">'+data[i].rss+ '</a></div> \
      </div> \
      <hr>';
  }
  document.getElementById("group_list_div").innerHTML = str;
}
</script>    
{% endblock %}